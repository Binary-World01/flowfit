<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Complete Your Profile - NutriQuest</title>

    <!-- Dark Mode Script -->
    <script src="js/dark-mode.js"></script>

    <!-- Performance: Preconnect for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com">

    <!-- Optimized: Only load needed font weights -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap"
        rel="stylesheet" />
    <!-- Material Icons - Standard working CDN -->
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap"
        rel="stylesheet" />
    <!-- Faster: Removed heavy plugins -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec1a",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102211",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1a331b",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    }
                }
            }
        }
    </script>

    <!-- CRITICAL FIX: Ensure all buttons/links are clickable -->
    <style>
        a,
        button,
        [role="button"],
        [onclick] {
            cursor: pointer !important;
            pointer-events: auto !important;
        }

        .material-symbols-outlined {
            pointer-events: none !important;
        }

        /* Progress bar animation */
        .progress-fill {
            transition: width 0.4s ease-out;
        }
    </style>

    <!-- Firebase SDK (v9 compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config & Init -->
    <script src="js/config.js"></script>
    <script src="js/firebase-init.js"></script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-[#111811] dark:text-white min-h-screen">

    <main class="max-w-2xl mx-auto p-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-3xl text-primary">eco</span>
                <h1 class="text-2xl font-bold">NutriQuest</h1>
            </div>
            <a href="welcome.html" class="text-sm text-gray-500 dark:text-gray-400 hover:text-primary">‚Üê Back</a>
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between text-sm font-bold mb-2">
                <span id="stepLabel">Step 1 of 3</span>
                <span id="progressPercent">33%</span>
            </div>
            <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                <div id="progressBar" class="progress-fill h-full bg-primary rounded-full" style="width: 33%"></div>
            </div>
        </div>

        <!-- Form Card -->
        <div
            class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-xl border border-gray-200 dark:border-white/5 p-8">

            <!-- Step 1: Personal Info -->
            <div id="step1" class="step-content">
                <div class="flex items-center gap-2 mb-6">
                    <span class="material-symbols-outlined text-3xl text-primary">person</span>
                    <h2 class="text-2xl font-bold">Personal Information</h2>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold mb-2" for="age">Age</label>
                        <input id="age" type="number" min="13" max="120" placeholder="25" required
                            class="w-full h-12 px-4 rounded-lg bg-gray-50 dark:bg-background-dark border border-gray-200 dark:border-gray-700 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all" />
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-2">Gender</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button type="button" data-gender="male"
                                class="gender-btn h-12 rounded-lg border-2 border-gray-200 dark:border-gray-700 hover:border-primary font-bold transition-all">Male</button>
                            <button type="button" data-gender="female"
                                class="gender-btn h-12 rounded-lg border-2 border-gray-200 dark:border-gray-700 hover:border-primary font-bold transition-all">Female</button>
                            <button type="button" data-gender="other"
                                class="gender-btn h-12 rounded-lg border-2 border-gray-200 dark:border-gray-700 hover:border-primary font-bold transition-all">Other</button>
                        </div>
                    </div>

                    <button onclick="nextStep()"
                        class="w-full h-12 bg-primary hover:bg-primary/90 text-white font-bold rounded-lg transition-all">
                        Next Step ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 2: Body Metrics -->
            <div id="step2" class="step-content hidden">
                <div class="flex items-center gap-2 mb-6">
                    <span class="material-symbols-outlined text-3xl text-primary">monitor_weight</span>
                    <h2 class="text-2xl font-bold">Body Metrics</h2>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold mb-2" for="height">Height (cm)</label>
                        <input id="height" type="number" min="100" max="250" placeholder="170" required
                            class="w-full h-12 px-4 rounded-lg bg-gray-50 dark:bg-background-dark border border-gray-200 dark:border-gray-700 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all"
                            oninput="calculateMetrics()" />
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-2" for="weight">Weight (kg)</label>
                        <input id="weight" type="number" min="30" max="300" placeholder="70" required
                            class="w-full h-12 px-4 rounded-lg bg-gray-50 dark:bg-background-dark border border-gray-200 dark:border-gray-700 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all"
                            oninput="calculateMetrics()" />
                    </div>

                    <!-- Live Calculation Results -->
                    <div id="metricsResults"
                        class="hidden bg-primary/5 dark:bg-primary/10 border border-primary/20 rounded-xl p-4 space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-bold text-gray-600 dark:text-gray-300">Your BMI</span>
                            <span id="bmiValue" class="text-lg font-bold text-primary"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-bold text-gray-600 dark:text-gray-300">BMR (Daily Calories at
                                Rest)</span>
                            <span id="bmrValue" class="text-lg font-bold text-primary"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-bold text-gray-600 dark:text-gray-300">Daily Calorie Target</span>
                            <span id="targetValue" class="text-lg font-bold text-primary"></span>
                        </div>
                        <p id="bmiCategory" class="text-xs text-gray-500 dark:text-gray-400 mt-2"></p>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="prevStep()"
                            class="flex-1 h-12 border-2 border-gray-300 dark:border-gray-600 hover:border-primary font-bold rounded-lg transition-all">
                            ‚Üê Back
                        </button>
                        <button onclick="nextStep()"
                            class="flex-1 h-12 bg-primary hover:bg-primary/90 text-white font-bold rounded-lg transition-all">
                            Next Step ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Review & Confirm -->
            <div id="step3" class="step-content hidden">
                <div class="flex items-center gap-2 mb-6">
                    <span class="material-symbols-outlined text-3xl text-primary">verified</span>
                    <h2 class="text-2xl font-bold">Review Your Profile</h2>
                </div>

                <div class="space-y-4 mb-6">
                    <div class="bg-gray-50 dark:bg-background-dark rounded-lg p-4">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Name</p>
                        <p id="reviewName" class="font-bold"></p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gray-50 dark:bg-background-dark rounded-lg p-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Age</p>
                            <p id="reviewAge" class="font-bold"></p>
                        </div>
                        <div class="bg-gray-50 dark:bg-background-dark rounded-lg p-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Gender</p>
                            <p id="reviewGender" class="font-bold"></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gray-50 dark:bg-background-dark rounded-lg p-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Height</p>
                            <p id="reviewHeight" class="font-bold"></p>
                        </div>
                        <div class="bg-gray-50 dark:bg-background-dark rounded-lg p-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Weight</p>
                            <p id="reviewWeight" class="font-bold"></p>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-background-dark rounded-lg p-4">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Goal</p>
                        <p id="reviewGoal" class="font-bold"></p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="prevStep()"
                        class="flex-1 h-12 border-2 border-gray-300 dark:border-gray-600 hover:border-primary font-bold rounded-lg transition-all">
                        ‚Üê Back
                    </button>
                    <button onclick="completeOnboarding()"
                        class="flex-1 h-12 bg-primary hover:bg-primary/90 text-white font-bold rounded-lg transition-all">
                        Complete Setup ‚úì
                    </button>
                </div>
            </div>

        </div>
    </main>

    <!-- Universal button handler -->
    <script src="js/universal-handler.js"></script>
    <script>
        let currentStep = 1;
        let selectedGender = null;
        let userData = {
            name: localStorage.getItem('userName') || '',
            goal: localStorage.getItem('selectedGoal') || 'lose',
            activity: 'moderate', // Default activity level
            age: null,
            gender: null,
            height: null,
            weight: null,
            bmi: null,
            bmr: null,
            dailyCalories: null
        };

        // Gender selection
        document.querySelectorAll('.gender-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.gender-btn').forEach(b => {
                    b.classList.remove('border-primary', 'bg-primary/10', 'text-primary');
                    b.classList.add('border-gray-200', 'dark:border-gray-700');
                });
                this.classList.add('border-primary', 'bg-primary/10', 'text-primary');
                this.classList.remove('border-gray-200', 'dark:border-gray-700');
                selectedGender = this.dataset.gender;
            });
        });

        function calculateMetrics() {
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const age = parseInt(document.getElementById('age').value);

            if (height && weight && age && selectedGender) {
                // Calculate BMI
                const heightInMeters = height / 100;
                const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);

                // Calculate BMR using Mifflin-St Jeor equation
                let bmr;
                if (selectedGender === 'male') {
                    bmr = Math.round(10 * weight + 6.25 * height - 5 * age + 5);
                } else if (selectedGender === 'female') {
                    bmr = Math.round(10 * weight + 6.25 * height - 5 * age - 161);
                } else {
                    bmr = Math.round(10 * weight + 6.25 * height - 5 * age - 78); // Average
                }

                // Calculate daily calorie target based on goal
                let multiplier = 1.375; // Light exercise default
                if (userData.goal === 'lose') {
                    multiplier = 1.2; // Sedentary for weight loss
                } else if (userData.goal === 'muscle') {
                    multiplier = 1.55; // Moderate exercise for muscle gain
                } else {
                    multiplier = 1.375; // Light exercise for maintenance
                }
                const dailyCalories = Math.round(bmr * multiplier);

                // Store in userData
                userData.bmi = bmi;
                userData.bmr = bmr;
                userData.dailyCalories = dailyCalories;

                // Display results
                document.getElementById('bmiValue').textContent = bmi;
                document.getElementById('bmrValue').textContent = bmr + ' cal';
                document.getElementById('targetValue').textContent = dailyCalories + ' cal';

                // BMI Category
                let category = '';
                if (bmi < 18.5) category = 'Underweight';
                else if (bmi < 25) category = 'Normal weight';
                else if (bmi < 30) category = 'Overweight';
                else category = 'Obese';
                document.getElementById('bmiCategory').textContent = `Category: ${category}`;

                document.getElementById('metricsResults').classList.remove('hidden');
            }
        }

        function nextStep() {
            // Validation
            if (currentStep === 1) {
                const age = document.getElementById('age').value;
                if (!age || !selectedGender) {
                    alert('Please fill in all fields');
                    return;
                }
                userData.age = parseInt(age);
                userData.gender = selectedGender;
            } else if (currentStep === 2) {
                const height = document.getElementById('height').value;
                const weight = document.getElementById('weight').value;
                if (!height || !weight) {
                    alert('Please enter your height and weight');
                    return;
                }
                userData.height = parseFloat(height);
                userData.weight = parseFloat(weight);

                // Show review data
                document.getElementById('reviewName').textContent = userData.name || 'Champion';
                document.getElementById('reviewAge').textContent = userData.age + ' years';
                document.getElementById('reviewGender').textContent = userData.gender.charAt(0).toUpperCase() + userData.gender.slice(1);
                document.getElementById('reviewHeight').textContent = userData.height + ' cm';
                document.getElementById('reviewWeight').textContent = userData.weight + ' kg';
                const goalNames = { lose: 'Lose Weight', muscle: 'Build Muscle', healthy: 'Stay Healthy' };
                document.getElementById('reviewGoal').textContent = goalNames[userData.goal] || 'Lose Weight';
            }

            // Move to next step
            currentStep++;
            updateStepDisplay();
        }

        function prevStep() {
            currentStep--;
            updateStepDisplay();
        }

        function updateStepDisplay() {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(step => step.classList.add('hidden'));

            // Show current step
            document.getElementById(`step${currentStep}`).classList.remove('hidden');

            // Update progress bar
            const progress = (currentStep / 3) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('stepLabel').textContent = `Step ${currentStep} of 3`;
            document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
        }

        function completeOnboarding() {
            console.log('üéØ === COMPLETING ONBOARDING ===');
            console.log('üìä Full userData object:', userData);
            console.log('üìã Keys in userData:', Object.keys(userData));
            console.log('üìù Stringified:', JSON.stringify(userData, null, 2));

            // Check if we have all required data
            const required = ['name', 'age', 'gender', 'height', 'weight', 'bmi', 'bmr', 'dailyCalories'];
            const missing = required.filter(key => !userData[key]);
            if (missing.length > 0) {
                console.error('‚ö†Ô∏è Missing data:', missing);
            }

            // Save all onboarding data to localStorage
            localStorage.setItem('onboardingData', JSON.stringify(userData));
            localStorage.setItem('onboardingComplete', 'pending');

            console.log('‚úÖ Saved to localStorage');
            console.log('üì¶ Verify saved data:', localStorage.getItem('onboardingData'));

            // Show success message
            alert('üéâ Profile complete! Now create your account to continue.');

            // Redirect to signup page
            window.location.href = 'signup.html';
        }
    </script>
</body>

</html>